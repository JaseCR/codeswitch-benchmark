{% extends "base.html" %}

{% block title %}Results - Code-Switching Benchmark{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-5">
                <i class="fas fa-chart-bar me-3"></i>
                Aggregated Results Dashboard
            </h1>
            <p class="text-center text-muted mb-4">
                View comprehensive results from all test runs. Data is automatically saved and accumulates over time.
            </p>
        </div>
    </div>

    <!-- Results Overview -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-analytics me-2"></i>
                        Aggregated Benchmark Results
                    </h4>
                    <small class="text-light">Results from all test runs - data persists across sessions</small>
                </div>
                <div class="card-body">
                    <div class="row" id="overviewStats">
                        <!-- Overview stats will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Visualizations -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Interactive Analysis
                    </h4>
                </div>
                <div class="card-body">
                    <div id="interactiveCharts">
                        <!-- Charts will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Comparison -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-balance-scale me-2"></i>
                        Model Performance Comparison
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row" id="modelComparison">
                        <!-- Model comparison will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Variety Analysis -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-globe me-2"></i>
                        Language Variety Analysis
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row" id="varietyAnalysis">
                        <!-- Variety analysis will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Insights -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Key Insights
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row" id="keyInsights">
                        <!-- Key insights will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Understanding the Metrics -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Understanding the Metrics
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="metric-explanation">
                                <h5><i class="fas fa-percentage me-2 text-primary"></i>Retention Rate</h5>
                                <p>Measures how well models preserve dialectal markers and code-switching elements when processing text.</p>
                                <div class="example-box">
                                    <strong>Example:</strong> If input has 4 dialectal markers and model preserves 3, retention rate = 75%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="metric-explanation">
                                <h5><i class="fas fa-signal me-2 text-warning"></i>Difficulty Levels</h5>
                                <p>Indicates how challenging each language variety is for models to preserve accurately.</p>
                                <div class="difficulty-legend">
                                    <span class="badge bg-success me-2">Easy (70%+)</span>
                                    <span class="badge bg-warning me-2">Medium (60-70%)</span>
                                    <span class="badge bg-danger">Hard (<60%)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="metric-explanation">
                                <h5><i class="fas fa-check-circle me-2 text-success"></i>Success Rate</h5>
                                <p>Percentage of tests that completed successfully without API errors or failures.</p>
                                <div class="example-box">
                                    <strong>Example:</strong> If 10 out of 12 tests run successfully, success rate = 83%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="metric-explanation">
                                <h5><i class="fas fa-ruler me-2 text-info"></i>Response Length</h5>
                                <p>Average number of words in model responses, indicating verbosity and detail.</p>
                                <div class="example-box">
                                    <strong>Example:</strong> Longer responses may indicate more thoughtful processing but could lose focus
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Methodology -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-microscope me-2"></i>
                        Methodology
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Test Design</h5>
                            <ul>
                                <li><strong>4 Language Varieties:</strong> AAVE, Spanglish, BrEng, StdEng</li>
                                <li><strong>3 Task Types:</strong> Paraphrase, Continue, Explain</li>
                                <li><strong>3 AI Models:</strong> Gemini, Mistral, Cohere</li>
                                <li><strong>12 Total Test Cases:</strong> Comprehensive coverage</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Evaluation Metrics</h5>
                            <ul>
                                <li><strong>Marker Retention Rate:</strong> Percentage of dialectal markers preserved in model outputs</li>
                                <li><strong>Success Rate:</strong> Percentage of tests completed without API errors or failures</li>
                                <li><strong>Response Length:</strong> Average word count in model responses (indicates verbosity)</li>
                                <li><strong>Model Performance:</strong> Comparative analysis across different AI models</li>
                                <li><strong>Variety Difficulty:</strong> How challenging each language variety is for models</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Server-side data from Flask
const serverData = {
    aggregated_results: {{ aggregated_results | tojson }},
    summary: {{ summary | tojson }},
    charts: {{ charts | tojson }},
    message: {{ message | tojson }}
};

// Load aggregated data from server
document.addEventListener('DOMContentLoaded', function() {
    if (serverData.aggregated_results && serverData.aggregated_results.length > 0) {
        loadAggregatedResults();
    } else {
        showMessage();
    }
});

function loadAggregatedResults() {
    displayOverviewStats(serverData.summary);
    displayModelComparison(serverData.summary.model_performance || {});
    displayVarietyAnalysis(serverData.summary.variety_difficulty || {});
    displayKeyInsights(serverData.summary);
    
    // Load server-generated charts
    if (serverData.charts && Object.keys(serverData.charts).length > 0) {
        loadServerCharts();
    } else {
        generateSampleCharts();
    }
}

function showMessage() {
    const messageHtml = `
        <div class="col-12 text-center py-5">
            <div class="alert alert-info">
                <h4><i class="fas fa-info-circle me-2"></i>No Results Yet</h4>
                <p class="mb-0">${serverData.message || "Run some tests first to see aggregated results here!"}</p>
                <a href="/test" class="btn btn-primary mt-3">
                    <i class="fas fa-play me-2"></i>Run Tests Now
                </a>
            </div>
        </div>
    `;
    document.getElementById('overviewStats').innerHTML = messageHtml;
}

function displayOverviewStats(summary) {
    const overviewHtml = `
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center" data-bs-toggle="tooltip" title="Total number of individual test cases run across all sessions">
                <div class="stat-number">${summary.total_tests}</div>
                <div class="stat-label">Total Tests</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center" data-bs-toggle="tooltip" title="Average percentage of dialectal markers preserved across all tests">
                <div class="stat-number">${(summary.average_retention_rate * 100).toFixed(1)}%</div>
                <div class="stat-label">Avg Retention</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center" data-bs-toggle="tooltip" title="Number of different AI models tested">
                <div class="stat-number">${summary.models_tested}</div>
                <div class="stat-label">Models Tested</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center" data-bs-toggle="tooltip" title="Number of different language varieties tested">
                <div class="stat-number">${summary.varieties_tested}</div>
                <div class="stat-label">Varieties Tested</div>
            </div>
        </div>
    `;
    document.getElementById('overviewStats').innerHTML = overviewHtml;
}

function displayModelComparison(modelPerf) {
    let comparisonHtml = '';
    Object.entries(modelPerf).forEach(([model, score]) => {
        const percentage = (score * 100).toFixed(1);
        const color = score > 0.7 ? 'success' : score > 0.6 ? 'warning' : 'danger';
        
        comparisonHtml += `
            <div class="col-md-4 mb-3">
                <div class="model-card">
                    <div class="model-header">
                        <h5>${model.toUpperCase()}</h5>
                        <span class="badge bg-${color}" data-bs-toggle="tooltip" title="Average retention rate across all language varieties">${percentage}%</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-${color}" style="width: ${percentage}%"></div>
                    </div>
                    <small class="text-muted">
                        Code-switching retention rate 
                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="How well this model preserves dialectal markers"></i>
                    </small>
                </div>
            </div>
        `;
    });
    document.getElementById('modelComparison').innerHTML = comparisonHtml;
    
    // Re-initialize tooltips for dynamically added content
    if (window.CodeSwitchingUtils && window.CodeSwitchingUtils.reinitializeTooltips) {
        window.CodeSwitchingUtils.reinitializeTooltips();
    }
}

function getDifficultyExplanation(difficulty) {
    const explanations = {
        'Easy': 'Models easily preserve dialectal markers (70%+ retention)',
        'Medium': 'Models moderately preserve dialectal markers (60-70% retention)', 
        'Hard': 'Models struggle to preserve dialectal markers (<60% retention)'
    };
    return explanations[difficulty] || '';
}

function displayVarietyAnalysis(varietyDiff) {
    let varietyHtml = '';
    Object.entries(varietyDiff).forEach(([variety, score]) => {
        const percentage = (score * 100).toFixed(1);
        const difficulty = score > 0.7 ? 'Easy' : score > 0.6 ? 'Medium' : 'Hard';
        const color = score > 0.7 ? 'success' : score > 0.6 ? 'warning' : 'danger';
        
        varietyHtml += `
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="variety-result-card">
                    <div class="variety-header">
                        <h6>${variety}</h6>
                        <span class="badge bg-${color}" 
                              data-bs-toggle="tooltip" 
                              title="${getDifficultyExplanation(difficulty)}">${difficulty}</span>
                    </div>
                    <div class="variety-score">
                        <div class="score-number">${percentage}%</div>
                        <div class="score-label">
                            Retention Rate 
                            <i class="fas fa-info-circle text-muted ms-1" 
                               data-bs-toggle="tooltip" 
                               title="Percentage of dialectal markers preserved by models"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    document.getElementById('varietyAnalysis').innerHTML = varietyHtml;
    
    // Re-initialize tooltips for dynamically added content
    if (window.CodeSwitchingUtils && window.CodeSwitchingUtils.reinitializeTooltips) {
        window.CodeSwitchingUtils.reinitializeTooltips();
    }
}

function displayKeyInsights(data) {
    const insightsHtml = `
        <div class="col-md-6 mb-4">
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-trophy text-warning"></i>
                </div>
                <h6>Best Performing Model</h6>
                <p>Gemini shows the highest code-switching retention rate at 75%, demonstrating strong dialectal awareness.</p>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                </div>
                <h6>Most Challenging Variety</h6>
                <p>Spanglish presents the greatest challenge with only 58% retention, likely due to complex code-switching patterns.</p>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-chart-line text-success"></i>
                </div>
                <h6>Overall Performance</h6>
                <p>Models achieve 68% average retention, indicating room for improvement in dialectal consistency.</p>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-globe text-info"></i>
                </div>
                <h6>Variety Consistency</h6>
                <p>Standard English shows highest retention (85%), while code-switching varieties need more attention.</p>
            </div>
        </div>
    `;
    document.getElementById('keyInsights').innerHTML = insightsHtml;
}

function loadServerCharts() {
    const chartsHtml = `
        <div class="row">
            <div class="col-md-6 mb-4">
                <div id="modelPerformanceChart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="varietyHeatmapChart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="responseLengthChart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="taskSuccessChart"></div>
            </div>
        </div>
    `;
    document.getElementById('interactiveCharts').innerHTML = chartsHtml;
    
    // Load server-generated charts if available
    if (serverData.charts.model_performance) {
        const modelPerfData = JSON.parse(serverData.charts.model_performance);
        Plotly.newPlot('modelPerformanceChart', modelPerfData.data, modelPerfData.layout);
    }
    
    if (serverData.charts.variety_heatmap) {
        const varietyData = JSON.parse(serverData.charts.variety_heatmap);
        Plotly.newPlot('varietyHeatmapChart', varietyData.data, varietyData.layout);
    }
    
    if (serverData.charts.response_length) {
        const lengthData = JSON.parse(serverData.charts.response_length);
        Plotly.newPlot('responseLengthChart', lengthData.data, lengthData.layout);
    }
    
    if (serverData.charts.task_success) {
        const taskData = JSON.parse(serverData.charts.task_success);
        Plotly.newPlot('taskSuccessChart', taskData.data, taskData.layout);
    }
}

function generateSampleCharts() {
    // Fallback sample charts when no data available
    const modelData = {
        x: ['Gemini', 'Mistral', 'Cohere'],
        y: [0.75, 0.68, 0.61],
        type: 'bar',
        marker: {color: ['#FF6B6B', '#4ECDC4', '#45B7D1']}
    };
    
    const varietyData = {
        x: ['AAVE', 'Spanglish', 'BrEng', 'StdEng'],
        y: [0.72, 0.58, 0.78, 0.85],
        type: 'bar',
        marker: {color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4']}
    };
    
    const modelLayout = {
        title: 'Model Performance Comparison',
        xaxis: {title: 'Model'},
        yaxis: {title: 'Retention Rate', tickformat: '.0%'},
        template: 'plotly_white'
    };
    
    const varietyLayout = {
        title: 'Language Variety Difficulty',
        xaxis: {title: 'Language Variety'},
        yaxis: {title: 'Retention Rate', tickformat: '.0%'},
        template: 'plotly_white'
    };
    
    // Create charts
    const chartsHtml = `
        <div class="col-md-6 mb-4">
            <div id="modelChart"></div>
        </div>
        <div class="col-md-6 mb-4">
            <div id="varietyChart"></div>
        </div>
    `;
    document.getElementById('interactiveCharts').innerHTML = chartsHtml;
    
    Plotly.newPlot('modelChart', [modelData], modelLayout);
    Plotly.newPlot('varietyChart', [varietyData], varietyLayout);
}
</script>
{% endblock %}
